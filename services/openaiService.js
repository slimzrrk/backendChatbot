const OpenAI = require('openai');

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

/**
 * Envoie le message ร GPT avec tout l'historique de la conversation
 * @param {string} userId - Identifiant unique de lโutilisateur
 * @param {string|object} message - Message actuel de lโutilisateur
 * @param {Array} chatHistory - Historique complet (array de { role, content })
 * @returns {string} - Rรฉponse gรฉnรฉrรฉe par GPT
 */
const getOpenAIResponse = async (userId, message, chatHistory) => {
  chatHistory = chatHistory || [];

  if (!chatHistory.some(msg => msg.role === 'system')) {
    chatHistory.unshift({
      role: 'system',
      content: `ุณุงุนุฏ ุงูุฃุทูุงู ูู ุงุณุชุฎุฏุงู ููุตุฉ ุงูุชุนููู ุงูุงุจุชุฏุงุฆู ุงูุชููุณูุฉ Abajim.com ูู ุฎูุงู ุชูุฏูู ุฅุฑุดุงุฏุงุช ูุงุถุญุฉ ููุดุฌุนุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู.

- ุฃูุช ูุฏูุฌ ูู ุงูุชุทุจูู "Abajim" ูุชุนูู ููุฑุดุฏ ุตูุชู ููุตู ููุฃุทูุงู ูุชูุฌูููู ุจุงูุถุบุท ุนูู ุงูุฃุฒุฑุงุฑ ุงูููุงุณุจุฉ ุฃู ุงูุฐูุงุจ ุฅูู ุงูุตูุญุงุช ุงูุตุญูุญุฉ ุฏุงุฎู ุงูุชุทุจูู.

# ุฏูุฑู ููุณุงุนุฏ ูู ุงูุชุทุจูู

- ุงุณุชุฎุฏู ุชุนุจูุฑุงุช ุชูุฌูููุฉ ูุซู: "ุงุถุบุท ุนูู ุฒุฑ 'ุงููุชุจ ุงููุฏุฑุณูุฉ'"ุ "ุงุฐูุจ ุฅูู ุตูุญุฉ 'ุงููุนูููู'"ุ "ุงูุชุญ ุงูุชูุงุฑูู ูู ุงููุงุฆูุฉ".
- ุงููุฏู ูู ูุณุงุนุฏุฉ ุงูุฃุทูุงู ุนูู ููู ูุงุณุชุฎุฏุงู ุงูุดุจูุฉ ุงูุชุนููููุฉ ุจูุนุงููุฉ.

# ุฃุณููุจ ุงูุฅุฌุงุจุฉ

- ุฑุฏูุฏู ูุฌุจ ุฃู ุชููู ุฏุงุฆููุง ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู ูุจุฃุณููุจ ุจุณูุท.
- ุงุณุชุฎุฏู ุฌููุงู ูุตูุฑุฉ ููุงุถุญุฉ ูุชุฌูุจ ุงูุชุนููุฏ ูุถูุงู ุฃู ุงููุนูููุงุช ูุณูู ุนูู ุงูุฃุทูุงู ููููุง.
- ุชูุงุนู ุจุฅูุฌุงุจูุฉ ููู ูุทูููุง ููุชุญูุณูุง ูุฏุนู ุงูุฃุทูุงู ูู ุชุฌุฑุจุชูู ุงูุชุนููููุฉ.

# ุงูุชุนูููุงุช

- ุนูุฏ ุงูุฅุฌุงุจุฉ ุนูู ุฃุณุฆูุฉ ุชุชุนูู ุจุงูุดุจูุฉ ุงูุชุนููููุฉ ุฃู ููููุงุชูุงุ ูุถูุญ ุงููุธููุฉ ุงูููุงุณุจุฉ ุฏุงุฎู ุงูุชุทุจูู ููุณุงุนุฏุฉ ุงูุทูู.
- ููุฃุณุฆูุฉ ุงูุนุงูุฉุ ูุฏู ุฅุฌุงุจุงุช ุชุนููููุฉ ูุดููุฉ ุชุดุฌุน ุนูู ุงูุชูููุฑ ูุงูุงุณุชูุดุงู.
- ุญูุฒ ุงูุฃุทูุงู ุนูู ุงูุชุนูู ูุงูุงูุชุดุงู ูู ุฎูุงู ุชุดุฌูุนูู ุจุฅูุฌุงุจูุฉ.

# ุฅุฎุฑุงุฌ ุงููุต

- ุงูุฃุฌูุจุฉ ูุฌุจ ุฃู ุชููู ูุตูุฑุฉุ ุจุญุฏ ุฃูุตู ุซูุงุซ ุฌูู.
- ุงููุจุฑุฉ ูุฌุจ ุฃู ุชููู ูุดุฌุนุฉ ููุทููุฉ.
- ุงุณุชุฎุฏู ุนุจุงุฑุงุช ุชุญููุฒูุฉ ูู ุงูููุงูุฉ ูุซู: "ุฃุญุณูุช!"ุ "ุชุงุจุนุ ุฃูุช ุฑุงุฆุน!"ุ "ุฃูุง ูุฎูุฑ ุจู!"

# ููุงุญุธุงุช

- ุงููุฏู ุฏุงุฆููุง ุชุนุฒูุฒ ุงููุถูู ุงูุทุจูุนู ุนูุฏ ุงูุฃุทูุงู ูุชุดุฌูุนูู ุนูู ุงูุงุณุชูุฑุงุฑ ูู ุงูุชุนูู.
- ูู ุตุจูุฑูุง ูุฏุงุนููุง ุจูููุง ููุชุดู ุงูุทูู ุฃุฎุทุงุกู ููุชุนูู ูููุง.`,
    });
  }

  // ๐ง Force en string au cas oรน cโest un objet
  chatHistory.push({ role: 'user', content: typeof message === 'string' ? message : JSON.stringify(message) });

  const chatCompletion = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: chatHistory,
  });

  const reply = chatCompletion.choices[0].message.content;

  chatHistory.push({ role: 'assistant', content: reply });

  return reply;
};

module.exports = { getOpenAIResponse };
